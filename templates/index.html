<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrikeTime</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#afcafe">
    <!-- Рекомендуемые иконки -->
<link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="/static/icon-512.png">

<!-- Для iOS (необязательно, но полезно) -->
<meta name="mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="/static/icon-192.png">
</head>
<body>
    <div class="lang-switcher">
        <button onclick="setLanguage('EN')">EN</button>
        <button onclick="setLanguage('RU')">RU</button>
        <button onclick="setLanguage('UA')">UA</button>
        <button onclick="setLanguage('PL')">PL</button>
    </div>

    <div class="container">
        <h1 id="title">TrikeTime</h1>
        <div class="status_card">
            <p id="status">Смена не начата</p>
            <button id="startBtn">Начать смену</button>
            <button id="endShiftBtn">Завершить смену</button>
        </div>
    </div>

    <div class="history-card">
        <h2 id="historyTitle">История смен</h2>
        <button id="clearHistoryBtn" class="btn-danger">Очистить историю</button>
        <button id="downloadHistoryBtn" class="btn-success">Скачать историю (CSV)</button>
    </div>
<div id="tokens" class="tokens">
  <div class="group">
    <span class="label">10h drive (2/wk)</span>
    <button class="token" data-key="drive10-1">10</button>
    <button class="token" data-key="drive10-2">10</button>
  </div>

  <div class="group">
    <span class="label">Daily rest 9h (3)</span>
    <button class="token" data-key="rest9-1">9</button>
    <button class="token" data-key="rest9-2">9</button>
    <button class="token" data-key="rest9-3">9</button>
  </div>

  <div class="group">
    <span class="label">Weekly rest 24h (comp)</span>
    <button class="token" data-key="rest24-1">24</button>
  </div>
</div>

<style>
.tokens { display:grid; gap:12px; }
.group { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.label { font-size:0.9rem; opacity:.7; min-width:200px; }
.token {
  width:44px; height:44px; border-radius:50%;
  border:2px solid #2e7d32; background:#e8f5e9; font-weight:700;
}
.token.used { position:relative; border-color:#999; background:#eee; color:#999; }
.token.used::after, .token.used::before{
  content:""; position:absolute; left:8px; right:8px; top:21px; height:2px; background:#d32f2f;
  transform:rotate(32deg);
}
.token.used::before{ transform:rotate(-32deg); }
</style>

<script>
(function(){
  const LS_KEY = 'tt_tokens_v1';
  const tokens = [...document.querySelectorAll('.token')];

  // загрузка состояния
  const state = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
  tokens.forEach(btn => { if (state[btn.dataset.key]) btn.classList.add('used'); });

  // клик по жетону
  tokens.forEach(btn => {
    btn.addEventListener('click', () => {
      const used = btn.classList.contains('used');
      const action = used ? 'вернуть' : 'использовать';
      if (!confirm(`Подтвердите: ${action} жетон "${btn.textContent}"`)) return;
      btn.classList.toggle('used');
      state[btn.dataset.key] = btn.classList.contains('used');
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    });
  });

  // недельный сброс «10 ч» — каждый понедельник 00:00
  function resetWeeklyIfNeeded(){
    const weekKey = 'tt_week_start';
    const last = localStorage.getItem(weekKey);
    const now = new Date();

    // Найти понедельник текущей недели
    const monday = new Date(now);
    const day = (now.getDay() + 6) % 7; // 0..6, где 0 = понедельник
    monday.setDate(now.getDate() - day);
    monday.setHours(0,0,0,0);
    const currWeekStart = monday.toISOString();

    if (last !== currWeekStart){
      // сбросить две "10"
      ['drive10-1','drive10-2'].forEach(k=>{
        state[k] = false;
        const el = document.querySelector(`[data-key="${k}"]`);
        el && el.classList.remove('used');
      });
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      localStorage.setItem(weekKey, currWeekStart);
    }
  }
  resetWeeklyIfNeeded();

  // вспомогательные API для твоей логики:
  window.TrikeTokens = {
    resetAfterWeeklyRest(){ // вызвать, когда зафиксировал недельный отдых
      ['rest9-1','rest9-2','rest9-3'].forEach(k=>{
        state[k] = false;
        const el = document.querySelector(`[data-key="${k}"]`);
        el && el.classList.remove('used');
      });
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    },
    restore24After45(){ // вызвать после полноценного 45ч или компенсации
      state['rest24-1'] = false;
      document.querySelector('[data-key="rest24-1"]').classList.remove('used');
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }
  };
})();
</script>
<script src="/static/core.js"></script>
<script src="/static/ai-helper.js"></script> 
    <script src="{{ url_for('static', filename='lang.js') }}"></script>
    <script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js')
        .then(reg => console.log('✅ Service Worker registered', reg))
        .catch(err => console.log('❌ Service Worker registration failed', err));
}
    </script>
    <script>
    (function(){
      function restore24After45(){
        state['rest24-1'] = false;
        document.querySelector('[data-key="rest24-1"]').classList.remove('used');
        localStorage.setItem(LS_KEY, JSON.stringify(state));
      }
      // если есть другие вспомогательные — оставь тут
      window.restore24After45 = restore24After45; // экспортируем наружу
    })();
    </script>
    <!-- Кнопка установки PWA -->
    <button id="installBtn" style="display:none">Download</button>
<script>
  let deferredPrompt;
  const btn = document.getElementById('installBtn');

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    btn.style.display = 'inline-block';
  });

  btn.addEventListener('click', async () => {
    btn.style.display = 'none';
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    console.log('PWA install:', outcome);
    deferredPrompt = null;
  });

  window.addEventListener('appinstalled', () => {
    console.log('TrikeTime installed');
  });
</script>


    <!-- ядро приложения -->
    <script src="/static/core.js"></script>

    <!-- AI-блок -->
    <script src="/static/ai-helper.js"></script>
</body>
</html>
